#!/usr/bin/env bash
set -e

CLUSTER="lab"

run() { echo "+ $*"; "$@"; }

install_k3d() {
    if command -v k3d >/dev/null; then
        echo "âœ” k3d already installed"
        return
    fi
    echo "ðŸ”§ Installing k3d..."
    curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
}

install_kubectl() {
    if command -v kubectl >/dev/null; then
        echo "âœ” kubectl already installed"
        return
    fi
    echo "ðŸ”§ Installing kubectl..."
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    chmod +x kubectl
    sudo mv kubectl /usr/local/bin/
}

create_cluster() {
    if k3d cluster list | grep -q "^$CLUSTER"; then
        echo "âœ” Cluster '$CLUSTER' already exists"
        return
    fi

    echo "ðŸš€ Creating k3d cluster..."
    k3d cluster create "$CLUSTER" \
        -p "8080:80@loadbalancer" \
        --k3s-arg "--disable=traefik@server:0"

    echo "ðŸ“¦ Installing Traefik ingress..."
    kubectl apply -f https://raw.githubusercontent.com/k3s-io/k3s/master/manifests/traefik.yaml
}

deploy_nginx() {
    if kubectl get deploy nginx >/dev/null 2>&1; then
        echo "âœ” nginx already deployed"
        return
    fi

    echo "ðŸ“¦ Deploying nginx..."
    kubectl create deployment nginx --image=nginx
    kubectl expose deployment nginx --port=80 --type=LoadBalancer
}

up() {
    install_k3d
    install_kubectl
    create_cluster
    deploy_nginx

    echo
    echo "âœ… Cluster ready!"
    echo "âž¡ Open: http://localhost:8080"
    echo "âž¡ Or via Cloud Shell Web Preview (port 8080)"
}

down() {
    echo "ðŸ§¹ Deleting cluster..."
    k3d cluster delete "$CLUSTER" || true
    echo "âœ… Cleanup done"
}

status() {
    k3d cluster list
    kubectl get pods -A
    kubectl get ingress
}

case "${1:-}" in
    up) up ;;
    down) down ;;
    status) status ;;
    *)
        echo "Usage: $0 {up|down|status}"
        exit 1
        ;;
esac
