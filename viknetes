#!/usr/bin/env bash
set -e

CLUSTER="lab"

run() { echo "+ $*"; "$@"; }

install_k3d() {
    if command -v k3d >/dev/null; then
        echo "‚úî k3d already installed"
        return
    fi
    echo "üîß Installing k3d..."
    curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
}

install_kubectl() {
    if command -v kubectl >/dev/null; then
        echo "‚úî kubectl already installed"
        return
    fi
    echo "üîß Installing kubectl..."
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    chmod +x kubectl
    sudo mv kubectl /usr/local/bin/
}

create_cluster() {
    if k3d cluster list | grep -q "^$CLUSTER"; then
        echo "‚úî Cluster '$CLUSTER' already exists"
        return
    fi

    echo "üöÄ Creating k3d cluster..."
    k3d cluster create "$CLUSTER" \
        -p "8080:80@loadbalancer" \
        --k3s-arg "--disable=traefik@server:0"
}

install_ingress() {
    echo "üåê Installing NGINX Ingress Controller..."
    kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml

    echo "‚è≥ Waiting for ingress controller..."
    kubectl wait \
      --namespace ingress-nginx \
      --for=condition=Available deployment/ingress-nginx-controller \
      --timeout=120s

    echo "‚è≥ Waiting for admission webhook jobs..."
    kubectl wait \
      --namespace ingress-nginx \
      --for=condition=Complete job/ingress-nginx-admission-create \
      --timeout=120s

    kubectl wait \
      --namespace ingress-nginx \
      --for=condition=Complete job/ingress-nginx-admission-patch \
      --timeout=120s
}


deploy_headlamp() {
    echo "üì¶ Deploying Headlamp..."

    kubectl apply -f - <<EOF
apiVersion: v1
kind: Namespace
metadata:
  name: viknetes-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: headlamp
  namespace: viknetes-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: headlamp
rules:
$(sed 's/^/  /' <<< "$(kubectl get clusterrole headlamp -o yaml 2>/dev/null || true)")
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: headlamp
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: headlamp
subjects:
- kind: ServiceAccount
  name: headlamp
  namespace: viknetes-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: headlamp
  namespace: viknetes-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: headlamp
  template:
    metadata:
      labels:
        app: headlamp
    spec:
      serviceAccountName: headlamp
      containers:
      - name: headlamp
        image: ghcr.io/headlamp-k8s/headlamp:latest
        args:
        - "-in-cluster"
        ports:
        - containerPort: 4466
---
apiVersion: v1
kind: Service
metadata:
  name: headlamp
  namespace: viknetes-system
spec:
  type: ClusterIP
  selector:
    app: headlamp
  ports:
  - port: 80
    targetPort: 4466
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: headlamp
  namespace: viknetes-system
spec:
  ingressClassName: nginx
  rules:
  - http:
      paths:
      - path: /headlamp
        pathType: Prefix
        backend:
          service:
            name: headlamp
            port:
              number: 80
EOF
}

up() {
    install_k3d
    install_kubectl
    create_cluster
    install_ingress
    deploy_headlamp

    echo
    echo "‚úÖ Cluster ready!"
    echo "‚û° Open Cloud Shell Web Preview on port 8080"
    echo "‚û° Headlamp UI: /headlamp"
}

down() {
    echo "üßπ Deleting cluster..."
    k3d cluster delete "$CLUSTER" || true
    echo "‚úÖ Cleanup done"
}

status() {
    k3d cluster list
    kubectl get pods -A
    kubectl get svc -A
    kubectl get ingress -A
}

case "${1:-}" in
    up) up ;;
    down) down ;;
    status) status ;;
    *)
        echo "Usage: $0 {up|down|status}"
        exit 1
        ;;
esac
