#!/usr/bin/env bash
set -e

CLUSTER="lab"

run() { echo "+ $*"; "$@"; }

install_k3d() {
    if command -v k3d >/dev/null; then
        echo "âœ” k3d already installed"
        return
    fi
    echo "ğŸ”§ Installing k3d..."
    curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
}

install_kubectl() {
    if command -v kubectl >/dev/null; then
        echo "âœ” kubectl already installed"
        return
    fi
    echo "ğŸ”§ Installing kubectl..."
    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    chmod +x kubectl
    sudo mv kubectl /usr/local/bin/
}

create_cluster() {
    if k3d cluster list | grep -q "^$CLUSTER"; then
        echo "âœ” Cluster '$CLUSTER' already exists"
        return
    fi

    echo "ğŸš€ Creating k3d cluster..."
    k3d cluster create "$CLUSTER" \
        -p "8080:80@loadbalancer" \
        --k3s-arg "--disable=traefik@server:0"
}

deploy_manifests() {
    local target="$1"

    if [[ -z "$target" ]]; then
        echo "â„¹ No manifests provided"
        return
    fi

    if [[ -f "$target" ]] || [[ -d "$target" ]]; then
        echo "ğŸ“¦ Applying manifests from $target"
        kubectl apply -f "$target"
    else
        echo "âŒ '$target' is not a valid file or directory"
        exit 1
    fi
}


up() {
    install_k3d
    install_kubectl
    create_cluster
    # Deploy Headlamp or any app
    deploy_manifests "manifests/headlamp"
    
    echo
    echo "âœ… Cluster ready!"
    echo "â¡ Open: http://localhost:8080"
    echo "â¡ Or via Cloud Shell Web Preview (port 8080)"
}

down() {
    echo "ğŸ§¹ Deleting cluster..."
    k3d cluster delete "$CLUSTER" || true
    echo "âœ… Cleanup done"
}

status() {
    k3d cluster list
    kubectl get pods -A
    kubectl get svc -A
}


case "${1:-}" in
    up) up ;;
    down) down ;;
    status) status ;;
    *)
        echo "Usage: $0 {up|down|status}"
        exit 1
        ;;
esac
